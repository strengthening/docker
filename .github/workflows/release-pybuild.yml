name: release-pybuild

on:
  push:
    tags:
      - 'release-pybuild-v*'

jobs:
  release:
    runs-on: ubuntu-16.04

    steps:
    - uses: actions/checkout@master
    - name: Login hongkong docker register.
      uses: azure/docker-login@v1
      with:
        login-server: registry.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALIYUN_DOCKER_REGISTER_USERNAME }}
        password: ${{ secrets.ALIYUN_DOCKER_REGISTER_PASSWORD }}

    - name: Push the image to hongkong aliyun register
      run: make pybuild

    - name: Push the buster image to hongkong aliyun register
      run: |
        cd pybuild && docker build --rm -t registry.cn-hongkong.aliyuncs.com/strengthening/pybuild:buster -f Dockerfile_buster .
        docker push registry.cn-hongkong.aliyuncs.com/strengthening/pybuild:buster
        
    - name: Login hangzhou docker register
      uses: azure/docker-login@v1
      with:
        login-server: registry.cn-hangzhou.aliyuncs.com
        username: ${{ secrets.ALIYUN_DOCKER_REGISTER_USERNAME }}
        password: ${{ secrets.ALIYUN_DOCKER_REGISTER_PASSWORD }}
    
    - name: Push the image to hangzhou aliyun register
      run: |
        docker tag registry.cn-hongkong.aliyuncs.com/strengthening/pybuild registry.cn-hangzhou.aliyuncs.com/strengthening/pybuild
        docker push registry.cn-hangzhou.aliyuncs.com/strengthening/pybuild
        docker tag registry.cn-hongkong.aliyuncs.com/strengthening/pybuild:buster registry.cn-hangzhou.aliyuncs.com/strengthening/pybuild:buster
        docker push registry.cn-hangzhou.aliyuncs.com/strengthening/pybuild:buster
